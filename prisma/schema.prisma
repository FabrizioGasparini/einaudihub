generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

/// *
///  * CLASSI (3A INF, 4B LING, ecc.)
model Class {
  id            String         @id @default(cuid())
  year          Int
  section       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  announcements Announcement[]
  events        Event[]
  polls         Poll[]
  posts         Post[]
  students      User[]
  userRoles     UserRole[]

  @@unique([year, section])
}

/// *
///  * UTENTI
///  * - email scolastica unica
///  * - relazione opzionale a Class
///  * - ruoli multipli tramite UserRole
model User {
  id             String                    @id @default(cuid())
  email          String                    @unique
  name           String
  avatarUrl      String?
  status         UserStatus                @default(ACTIVE)
  classId        String?
  interests      String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  emailVerified  DateTime?
  accounts       Account[]
  announcements  Announcement[]
  auditLogs      AuditLog[]
  hiddenComments Comment[]                 @relation("CommentHiddenBy")
  comments       Comment[]
  conversations  ConversationParticipant[]
  events         Event[]                   @relation("EventCreator")
  participations EventParticipation[]
  sentMessages   Message[]                 @relation("MessageSender")
  polls          Poll[]                    @relation("PollCreator")
  pollVotes      PollVote[]
  hiddenPosts    Post[]                    @relation("PostHiddenBy")
  posts          Post[]
  postLikes      PostLike[]
  handledReports Report[]                  @relation("ReportHandler")
  reports        Report[]                  @relation("Reporter")
  sessions       Session[]
  class          Class?                    @relation(fields: [classId], references: [id])
  roles          UserRole[]

  @@index([classId])
  @@index([status])
}

/// *
///  * RUOLI UTENTE CON SCOPE
///  *
///  * - role: tipo di ruolo
///  * - classId: opzionale, per scope di classe (CLASS_REP, eventualmente altri)
///  * - schoolWide: true se il ruolo vale per tutto l'istituto
model UserRole {
  id         String   @id @default(cuid())
  userId     String
  role       RoleName
  classId    String?
  schoolWide Boolean  @default(false)
  createdAt  DateTime @default(now())
  class      Class?   @relation(fields: [classId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, role])
  @@index([classId])
}

/// *
///  * EVENTI
///  * - possono essere di istituto (classId null) o di classe (classId specifico)
model Event {
  id             String               @id @default(cuid())
  title          String
  description    String
  date           DateTime
  location       String?
  createdById    String
  classId        String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  class          Class?               @relation(fields: [classId], references: [id])
  createdBy      User                 @relation("EventCreator", fields: [createdById], references: [id], onDelete: Cascade)
  participations EventParticipation[]

  @@index([date])
  @@index([classId])
}

/// *
///  * PARTECIPAZIONE AGLI EVENTI
model EventParticipation {
  id        String              @id @default(cuid())
  userId    String
  eventId   String
  status    ParticipationStatus
  createdAt DateTime            @default(now())
  event     Event               @relation(fields: [eventId], references: [id])
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId])
}

/// *
///  * CATEGORIE PER LA BACHECA STUDENTI
///  * Es.: "Generale", "Sport", "Musica", "Progetti", ecc.
model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  posts     Post[]
}

/// *
///  * POST DELLA BACHECA STUDENTI
///  * - possono essere globali (classId null) o di classe
///  * - moderazione soft tramite isHidden / hiddenById
model Post {
  id         String     @id @default(cuid())
  title      String
  content    String
  authorId   String
  categoryId String?
  classId    String?
  isHidden   Boolean    @default(false)
  hiddenById String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  comments   Comment[]
  hiddenBy   User?      @relation("PostHiddenBy", fields: [hiddenById], references: [id])
  class      Class?     @relation(fields: [classId], references: [id])
  category   Category?  @relation(fields: [categoryId], references: [id])
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes      PostLike[]
  reports    Report[]   @relation("PostReports")

  @@index([classId])
  @@index([isHidden])
  @@index([authorId])
}

/// *
///  * COMMENTI AI POST
///  * - anche qui moderazione soft
model Comment {
  id         String   @id @default(cuid())
  postId     String
  authorId   String
  content    String
  isHidden   Boolean  @default(false)
  hiddenById String?
  createdAt  DateTime @default(now())
  hiddenBy   User?    @relation("CommentHiddenBy", fields: [hiddenById], references: [id])
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post       Post     @relation(fields: [postId], references: [id])
  reports    Report[] @relation("CommentReports")

  @@index([postId])
  @@index([authorId])
}

/// *
///  * ANNUNCI (AVVISI)
///  * - di classe (classId non null, isOfficial false)
///  * - ufficiali di istituto (classId null, isOfficial true, tipicamente SCHOOL_REP / ADMIN)
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String
  createdById String
  classId     String?
  isOfficial  Boolean  @default(false)
  createdAt   DateTime @default(now())
  class       Class?   @relation(fields: [classId], references: [id])
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([classId, isOfficial])
  @@index([createdById])
}

/// *
///  * SONDAGGI
///  * - di classe (classId non null, schoolWide = false)
///  * - di istituto (classId null, schoolWide = true)
model Poll {
  id          String       @id @default(cuid())
  question    String
  createdById String
  classId     String?
  schoolWide  Boolean      @default(false)
  endsAt      DateTime?
  createdAt   DateTime     @default(now())
  class       Class?       @relation(fields: [classId], references: [id])
  createdBy   User         @relation("PollCreator", fields: [createdById], references: [id], onDelete: Cascade)
  options     PollOption[]
  votes       PollVote[]

  @@index([classId])
  @@index([schoolWide])
  @@index([endsAt])
}

/// *
///  * OPZIONI DI UN SONDAGGIO
model PollOption {
  id        String     @id @default(cuid())
  pollId    String
  text      String
  createdAt DateTime   @default(now())
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes     PollVote[]

  @@index([pollId])
}

/// *
///  * VOTI AI SONDAGGI
///  * - un solo voto per utente per sondaggio
model PollVote {
  id        String     @id @default(cuid())
  pollId    String
  optionId  String
  userId    String
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)

  @@unique([pollId, userId])
  @@index([optionId])
  @@index([userId])
}

/// *
///  * SEGNALAZIONI (REPORT) PER MODERAZIONE
///  * - possono riferirsi a un post o a un commento
model Report {
  id          String   @id @default(cuid())
  reporterId  String
  postId      String?
  commentId   String?
  reason      String
  handled     Boolean  @default(false)
  handledById String?
  createdAt   DateTime @default(now())
  handledBy   User?    @relation("ReportHandler", fields: [handledById], references: [id])
  comment     Comment? @relation("CommentReports", fields: [commentId], references: [id])
  post        Post?    @relation("PostReports", fields: [postId], references: [id])
  reporter    User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([commentId])
  @@index([handled])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@index([postId])
}

model Conversation {
  id           String                    @id @default(cuid())
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  userId         String
  conversationId String
  hasUnread      Boolean      @default(false)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  senderId       String
  conversationId String
  read           Boolean      @default(false)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  details   String?
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([userId])
}

/// *
///  * RUOLI
///  *
///  * STUDENT      -> ruolo base
///  * CLASS_REP    -> rappresentante di classe
///  * SCHOOL_REP   -> rappresentante d'istituto
///  * MODERATOR    -> moderatore tecnico
///  * ADMIN        -> amministratore di sistema
enum RoleName {
  STUDENT
  CLASS_REP
  SCHOOL_REP
  MODERATOR
  ADMIN
}

/// *
///  * Stato partecipazione eventi
enum ParticipationStatus {
  GOING
  NOT_GOING
  INTERESTED
}

/// *
///  * Stato account utente (per eventuali blocchi/sospensioni)
enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}
